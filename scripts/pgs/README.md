# Tools/Scripts

------------------------
#### This directory contains scripts/tools to generate visualizations from viral pipelines data - specifically for Enterics.
------------------------

### Scripts

#### **create_enterics_visualizations_html.py**

##### What does it do?
The create_enterics_visualizations_html script is used to generate quality control (QC) visualizations for bacterial sequencing data. We rely on relevant QC metrics — estimated coverage, number of contigs, and assembly length — to assess the sequencing quality of the different samples. The visualizations are created using Plotly to allow for interactive charts and graphs, which are then compiled into an HTML report. No server is required to access the report — simply download the output HTML and open in your browser of choice.

##### What does it require as input?
This script has both required and optional inputs, and requires access to the Firecloud API to extract necessary samples and their data.

###### Required inputs:
- sample_ids: A list of sample IDs for which the QC visualizations will be generated, each sample separated by a space.
- workspace_name: The name of the Terra workspace where the data resides.
- workspace_project: The name of the billing project associated with the workspace.
- input_table_name: The name of the Terra data table from which the input data is selected. This is not the table with sets — it is the original table where the data lives that the selected set is referencing.

###### Optional inputs:
- grouping_column_name (default "gambit_predicted_taxon"): The name of the column used for grouping/coloring in the visualizations, typically representing the predicted organism taxon.
- thresholds_file: a JSON file specifying custom thresholds for the respective QC metrics. The following thresholds are included in the workflow, each broken down by genus:

	- Estimated Coverage (est_coverage_clean):
		- Listeria: 20
		- Campylobacter: 20
		- Escherichia: 40
		- Salmonella: 30
		- Vibrio: 40
	- Number of Contigs (number_contigs):
		- Listeria: 100
		- Campylobacter: 200
		- Escherichia: 600
		- Salmonella: 400
		- Vibrio: 200
	- Assembly Length (assembly_length):
		- Listeria: min 2,800,000, max 3,100,000
		- Campylobacter: min 1,400,000, max 2,200,000
		- Escherichia: min 4,200,000, max 5,900,000
		- Salmonella: min 4,400,000, max 5,600,000
		- Vibrio: min 3,800,000, max 5,300,000

If you wish to override any of these thresholds or add a new treshold, you may do so by passing in a json file with the metric, genus name and the relevant value to each metric's input space. Note that the json file must be uploaded to your Terra workspace to be accessible when configuring the workflow's inputs. The metrics must be exactly defined as:
- "est_coverage_clean" for estimated coverage
- "number_contigs" for number of contigs
- "assembly_length" for assembly length
	- note that the upper and lower thresholds must be marked by "min" and "max"

An example of a valid json file if we wanted to add metrics for Klevsiella and Shigella would look like:

{
  "est_coverage_clean": {
    "Klebsiella": 17,
    "Shigella": 17
  },
  "number_contigs": {
    "Klebsiella": 17,
    "Shigella": 17
  },
  "assembly_length": {
    "Klebsiella": {
      "min": 1500000,
      "max": 2500000
    },
    "Shigella": {
      "min": 1500000,
      "max": 2500000
    }
  }
}

Please not that this example json file does not contain real values and is only provided for reference.

##### What does it return as output?
- visualization_html: An HTML file (QC_visualizations.html by default) containing interactive QC visualizations. This report includes various plots and tables summarizing the QC metrics for the provided samples, allowing for a comprehensive review of sequencing quality across different metrics and samples.

#### **create_visualizations.py**
##### Description
    Accepts sample data from the data model in user's workspace and generates visualization outputs. Visualizations are generated by grouping organisms from the gambit_predicted_taxon column. Metrics and specific thresholds used to generate plots that are organism specific and outputs contain colorized demarcations to indicate sample PASS/FAIL based on pre-defined thresholds.

    Outputs:
        1. QC_visualizations.pdf: Contains 3 sets of scatter-plots of all organisms, failed samples table, scatter-plot per organism with threshold lines and colored to indicate pass/fail samples where each set represents metrics defined in Pulsenet metrics.
        2. Colorized_Scores.xlsx: Contains grid of all samples, Pulsenet metrics, colored by PASS/FAIL values as well as a second tab containing summary statistics.
    
    WDL:
        1. [Enterics Visualization WDL - FULL](https://github.com/broadinstitute/viral-pipelines/blob/master/pipes/WDL/workflows/create_enterics_qc_viz.wdl)

#### **general_create_visualizations.py**
##### Description
    Accepts sample data from the data model in user's workspace and generates visualization outputs. Visualizations are generated by grouping organisms from the gambit_predicted_taxon column. There are no organism specific plots in this version - no thresholds but only single plots of all organisms to show trends in a scatter-plot.

    Outputs:
        1. QC_visualizations.pdf: Contains 3 sets of scatter-plots of all organisms. No failed samples tables or per oerganism plots with threshold lines will be included.
    
    WDL:
        1. 1. [Enterics Visualization WDL - GENERAL](https://github.com/broadinstitute/viral-pipelines/blob/master/pipes/WDL/workflows/general_create_enterics_qc_viz.wdl)
